<?php

/**
 * Plugin Name: Norby AI
 * Plugin URI: https://norby.io
 * Description: Norby WordPress plugin
 * Version: 1.0.3
 * Author: Jevgeni Sultanov
 * License: GPLv3
 * Text Domain: norby
 * Requires at least: 5.2
 */

define( 'NORBY_DIR_PATH', plugin_dir_path(__FILE__) );
define( 'NORBY_FORM_PATH', NORBY_DIR_PATH . 'view'. DIRECTORY_SEPARATOR . 'settings.php' );
define( 'NORBY_WIDGET_PATH', NORBY_DIR_PATH . 'view'. DIRECTORY_SEPARATOR . 'widget.php' );
define( 'NORBY_SAVE_SETTINGS_PATH', NORBY_DIR_PATH . 'api' . DIRECTORY_SEPARATOR . 'save.php' );
define( 'NORBY_STYLE_URL', plugins_url( 'assets/css/style.css', __FILE__ ) );
define( 'NORBY_SCRIPT_URL', plugins_url( 'assets/js/app.js', __FILE__ ) );

const NORBY_PREFIX = 'norby_';
const NORBY_API_KEY = 'api_key';
const NORBY_LANGUAGE = 'locale';
const NORBY_COLOR = 'color';
const NORBY_ICON_COLOR = 'icon_color';
const NORBY_BOT_NAME = 'bot_name';
const NORBY_MULTI_CHAT = 'multi_chat';
const NORBY_IMAGE_TRANSFER = 'image_transfer';
const NORBY_INFO_PAGE = 'information_page';
const NORBY_WIDGET_POSITION = 'side';
const NORBY_DESKTOP_SIDE_MARGIN = 'margin_side_desktop';
const NORBY_DESKTOP_BOTTOM_MARGIN = 'margin_bottom_desktop';
const NORBY_MOBILE_SIDE_MARGIN = 'margin_side_mobile';
const NORBY_MOBILE_BOTTOM_MARGIN = 'margin_bottom_mobile';
const NORBY_OPTION_API_KEY = NORBY_PREFIX . NORBY_API_KEY;
const NORBY_OPTION_LANGUAGE = NORBY_PREFIX . NORBY_LANGUAGE;
const NORBY_OPTION_COLOR = NORBY_PREFIX . NORBY_COLOR;
const NORBY_OPTION_ICON_COLOR = NORBY_PREFIX . NORBY_ICON_COLOR;
const NORBY_OPTION_BOT_NAME = NORBY_PREFIX . NORBY_BOT_NAME;
const NORBY_OPTION_MULTI_CHAT = NORBY_PREFIX . NORBY_MULTI_CHAT;
const NORBY_OPTION_IMAGE_TRANSFER = NORBY_PREFIX . NORBY_IMAGE_TRANSFER;
const NORBY_OPTION_INFO_PAGE = NORBY_PREFIX . NORBY_INFO_PAGE;
const NORBY_OPTION_WIDGET_POSITION = NORBY_PREFIX . NORBY_WIDGET_POSITION;
const NORBY_OPTION_DESKTOP_SIDE_MARGIN = NORBY_PREFIX . NORBY_DESKTOP_SIDE_MARGIN;
const NORBY_OPTION_DESKTOP_BOTTOM_MARGIN = NORBY_PREFIX . NORBY_DESKTOP_BOTTOM_MARGIN;
const NORBY_OPTION_MOBILE_SIDE_MARGIN = NORBY_PREFIX . NORBY_MOBILE_SIDE_MARGIN;
const NORBY_OPTION_MOBILE_BOTTOM_MARGIN = NORBY_PREFIX . NORBY_MOBILE_BOTTOM_MARGIN;
const NORBY_ALLOWED_LANGUAGES = ['en' => 'English', 'ee' => 'Estonian', 'ru' => 'Russian'];
const NORBY_ALLOWED_POSITIONS = ['left' => 'Left', 'right' => 'Right'];

const NORBY_API_URL = 'https://api.norby.io';
const NORBY_WIDGET_URL = 'https://chat.norby.io/widget';
const NORBY_SIGNUP_URL = 'https://chat.norby.io/signup';
const NORBY_DOCUMENTATION_URL = 'https://norby-io.notion.site/How-to-Customize-the-Widget-for-Your-Needs-0ea75994da6a4fdab9ff305025dd8275';
const NORBY_DEFAULT_API_KEY = '';
const NORBY_DEFAULT_LANGUAGE = 'en';
const NORBY_DEFAULT_COLOR = '#e61c42';
const NORBY_DEFAULT_ICON_COLOR = '#e61c42';
const NORBY_DEFAULT_BOT_NAME = 'Bot';
const NORBY_DEFAULT_MULTI_CHAT = true;
const NORBY_DEFAULT_IMAGE_TRANSFER = false;
const NORBY_DEFAULT_INFO_PAGE = true;
const NORBY_DEFAULT_WIDGET_POSITION = 'right';
const NORBY_DEFAULT_DESKTOP_SIDE_MARGIN = 150;
const NORBY_DEFAULT_DESKTOP_BOTTOM_MARGIN = 150;
const NORBY_DEFAULT_MOBILE_SIDE_MARGIN = 120;
const NORBY_DEFAULT_MOBILE_BOTTOM_MARGIN = 120;

function norby_plugin_setup_menu()
{
    $norby_icon = 'data:image/svg+xml;base64,PHN2ZyBmaWxsPSJub25lIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgODAgODAiIHdpZHRoPSI4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSIjZTYxYzQyIj48cGF0aCBkPSJtMzQuNTQ5IDY5LjQ2NzZjLTExLjEwNS0yLjM0NTYtMjAuMzA4Mi0xMi4xNy0yMS44MDI1LTIzLjI1MjItLjQ3NTQtMy42MDM0LS4xNjk4LTguNTY2Ni43NDcxLTExLjc5NjEgMi40MTEyLTguNDk4NiA5Ljk4NDQtMTYuMjgzMyAxOC40NDA1LTE4LjkwMDggMi43ODQ3LS44NDk5IDMuMDkwNC0uNDQyIDEuNjY0IDIuNDEzNi0xLjAxODggMi4xMDc2LTEuMTg4NiAyLjI0MzYtMy41MzE4IDMuMzk5NC03Ljk0NjcgMy44MDc0LTEyLjgzNyAxMS43MjgxLTEyLjg3MSAyMC43NzA2IDAgMS44MDE3LjIzNzcgNC4wNzkzLjU0MzQgNS40MzkxLjc4MTEgMy4xOTU1IDMuMDIyNCA3LjU4MDcgNC44OTAzIDkuNjg4NGwxLjU2MjEgMS43MzM3IDMuMzYyMS0uNTc3OWMyLjU0Ny0uNDQxOSA0LjUxNjctLjU0MzkgOC4zMjAzLS40MDc5IDUuNTY5NS4yMDM5IDguODI5Ny44ODM4IDEzLjY1MiAyLjgyMTVsMi45ODg1IDEuMjIzOCAxLjQ5NDMtMS4wNTM4YzMuNzM1Ni0yLjU0OTYgNy40MDMzLTcuOTIwNyA4Ljc2MTctMTIuNzgxOS43NDcyLTIuNjUxNi42NDUzLTEwLjQwMjMtLjE2OTgtMTIuNzQ3OS0yLjI0MTMtNi41MjY5LTYuNDE4NS0xMS40OTAxLTExLjg4NjEtMTQuMDczNy0xLjAxODgtLjQ3NTktMS45MzU3LTEuMDE5OC0yLjAzNzYtMS4xNTU4cy4wMzQtMS4xMjE4LjIzNzctMi4xMDc3Yy4zMDU3LTEuMjU3OC42MTEzLTEuOTAzNy45ODQ5LTEuOTcxNi45MTY5LS4xNyA1LjcwNTMgMi40ODE1IDguMTUwNSA0LjUyMTIgNC4yMTEgMy40Njc0IDcuODQ0OCA5LjExMDUgOS4zMzkgMTQuNDQ3Ni40NDE1IDEuNjY1OC42MTEzIDMuNDY3NS42MTEzIDcuMTM4OSAwIDQuMjE1My0uMTM1OCA1LjMwMzEtLjgxNSA3LjQ3ODctNC40ODI4IDE0LjMxMTctMTguNDA2NSAyMi43NDIzLTMyLjYzNTkgMTkuNzUwOHoiLz48cGF0aCBkPSJtMzguMTE0OSA1Ni4xNDE5Yy0xLjI5MDUtLjE3LTMuNjY3Ny0uNjQ1OS01LjI2MzgtMS4wMTk4LTMuMjI2My0uNzgxOS05LjkxNjQtMy40Njc1LTEwLjU2MTctNC4yNDkzLS4yNzE3LS4zNC0uMzM5Ni0xLjI1NzgtLjE2OTgtMy4xNjE1bC4yMzc3LTIuNzE5Ni0xLjI5MDQtLjEwMTktMS4yOTA1LS4xMDIuMTAxOC0yLjQ0NzZjLjA2OC0xLjM1OTguMjAzOC0zLjA5MzUuMzM5Ny0zLjkwOTQuMjcxNi0xLjQ2MTcuMjcxNi0xLjQ2MTcgMS42My0xLjM5MzhsMS4zOTI0LjAzNC40MDc1LTMuNjAzNGMuMjM3OC0yLjAwNTYuNTA5NC0zLjczOTQuNjQ1My0zLjg3NTMuNDc1NC0uNDc2IDQuNDE0OC0xLjMyNTggNy45ODA3LTEuNzMzNyAzLjM5Ni0uMzc0IDMuNjMzNy0uNDQyIDMuNjMzNy0xLjE1NTkgMC0uOTUxOC40NDE1LTEuMTg5OCAyLjAzNzYtMS4xODk4bDEuMzI0NS4wMzQgMS4wMTg4LTMuMDkzNSAxLjAxODgtMy4wNTk1LTIuNDc5MS4yMzhjLTEuNTYyMi4xMzYtMi41ODEuMTAyLTIuNzE2OC0uMTM2LS4yMDM4LS4zMDU5IDYuNjIyMi0xNS4xNjE0OSA3LjMwMTQtMTUuODQxMzcuMjAzOC0uMTY5OTguNDQxNS0uMTY5OTguNjQ1My4wMzM5OS4yMDM3LjIwMzk3LS4xMzU5IDIuMjA5NjQtLjg0OSA1LjU0MTA5LS42NDUzIDIuODg5NDktMS4xODg3IDUuMzcxMDktMS4xODg3IDUuNTQxMDkgMCAuMTM2Ljk4NDkuMjcyIDIuMjA3NS4yNzIgMS42MzAxIDAgMi4yNzUzLjEzNTkgMi40MTExLjQ3NTkuMTAxOS4yNzE5LS4zMDU2IDIuNjg1NS0uODgyOSA1LjMwMzEtLjYxMTMgMi42NTE2LS45ODQ5IDQuOTI5Mi0uODQ5IDUuMDMxMi4xMzU4LjEzNi44NDkuMzczOSAxLjYzMDEuNTc3OSAxLjMyNDQuMzA1OSAxLjQyNjMuNDA3OSAxLjM1ODQgMS4zOTM4LS4xMDE5IDEuMDE5OC0uMDM0IDEuMDUzOCAyLjAzNzYgMS42MzE3IDIuNDc5MS42Nzk5IDguMjE4NCAzLjE2MTUgOC42NTk5IDMuNzA1NC4yMDM3LjIzNzkuMjAzNyAxLjI5MTguMDMzOSAyLjYxNzYtLjEzNTggMS4yMjM3LS4zMzk2IDIuODU1NS0uNDQxNSAzLjYzNzRsLS4xNjk4IDEuNDI3NyAxLjI1NjYuMTAyIDEuMjU2NS4xMDItLjEwMTkgMy41MzU0Yy0uMTAxOSA0LjA0NTMtLjMzOTYgNC41ODkyLTIuMDAzNiA0LjI4MzMtMS4yNTY2LS4yMzgtMS4yNTY2LS4xNy0xLjU5NjIgMy4xOTU1LS4xMDE4IDEuMDE5OC0uMzczNSAyLjA3MzYtLjYxMTMgMi4zMTE2LTEuMzU4NCAxLjM1OTgtMTIuOTA0OSAyLjQ4MTYtMTguMTAwOCAxLjc2Nzd6bTkuNDA3LTUuNDM5MWMxLjkzNTgtLjIwNCAzLjYzMzgtLjQ3NTkgMy43Njk2LS42MTE5LjIzNzctLjIzOCAxLjU5NjEtMTEuMTE2MiAxLjU5NjEtMTIuOTg1OSAwLS43ODE4LS4yNzE2LS45NTE4LTIuNjE0OS0xLjc2NzctNC4zMTMtMS40NjE3LTYuNzkyMS0xLjkzNzctMTEuNDc4Ni0yLjE3NTYtMy42MzM3LS4xNy05LjEwMTMuMjM3OS05LjU3NjguNjc5OS0uMTY5OC4yMDM5LTEuNDk0MiAxMy4yNTc4LTEuMzU4NCAxMy42NjU3LjI3MTcuNjQ1OSA2LjY1NjIgMi41NDk2IDEwLjMyMzkgMy4wNTk1IDQuMjc5LjU3NzkgNS4xMjguNTc3OSA5LjMzOTEuMTM2eiIvPjxwYXRoIGQ9Im00Ni40MzUyIDQzLjc2NzgtLjc4MTEtLjg0OTgtMS4xNTQ2LjcxMzhjLTEuMDUyOC42Nzk5LTEuMTg4Ni42Nzk5LTEuOTY5Ny4xNy0xLjI5MDUtLjg0OTgtMS4wODY3LTEuOTcxNi41NzczLTMuMzk5NCAyLjAzNzYtMS43MzM3IDMuMzI4MS0xLjY5OTcgNS4wNjAxLjIwNCAxLjQ2MDMgMS41OTc3IDEuNjY0IDIuNTgzNS43MTMyIDMuNDMzNC0uODgzLjc4MTgtMS41MjgzLjcxMzktMi40NDUyLS4yNzJ6Ii8+PHBhdGggZD0ibTM1LjkwNzMgNDIuNzE0MWMtLjk4NDktLjg0OTktMS4wODY4LS44NDk5LTEuNjY0MS0uMzM5OS0uNzQ3MS42Nzk4LTIuMjA3NC43MTM4LTIuNzE2OC4wNjc5LS43ODExLS45MTc4LS4yNzE3LTIuMjQzNiAxLjIyMjUtMy4zNjU0IDEuOTY5Ny0xLjM5MzcgMy4yMjYzLTEuMzI1NyA0Ljg5MDMuMzA2IDEuNjY0MSAxLjU5NzcgMS44MzM5IDIuMzc5Ni44MTUxIDMuMzk5NHMtMS4yMjI2IDEuMDE5OC0yLjU0Ny0uMDY4eiIvPjwvZz48L3N2Zz4=';

    add_menu_page(
        'Norby AI Chat Bot Widget',
        'Norby',
        'manage_options',
        'norby',
        'norby_plugin_init_form',
        $norby_icon,
        70
    );
}
add_action( 'admin_menu', 'norby_plugin_setup_menu' );

function norby_plugin_init_form()
{
    require_once NORBY_FORM_PATH;
}

function norby_plugin_meta_data( $links_array, $plugin_file_name, $plugin_data, $status ) {
    if ( strpos( $plugin_file_name, basename(__FILE__) ) ) {
        $links_array[] = '<a href="' . NORBY_DOCUMENTATION_URL . '" target="_blank" rel="noopener noreferrer">Docs</a>';
    }

    return $links_array;
}

add_filter( 'plugin_row_meta', 'norby_plugin_meta_data', 10, 4 );

function norby_plugin_activate()
{
    add_option( NORBY_OPTION_API_KEY, NORBY_DEFAULT_API_KEY );
    add_option( NORBY_OPTION_LANGUAGE, NORBY_DEFAULT_LANGUAGE );
    add_option( NORBY_OPTION_COLOR, NORBY_DEFAULT_COLOR );
    add_option( NORBY_OPTION_ICON_COLOR, NORBY_DEFAULT_ICON_COLOR );
    add_option( NORBY_OPTION_MULTI_CHAT,  NORBY_DEFAULT_MULTI_CHAT );
    add_option( NORBY_OPTION_BOT_NAME, NORBY_DEFAULT_BOT_NAME );
    add_option( NORBY_OPTION_IMAGE_TRANSFER, NORBY_DEFAULT_IMAGE_TRANSFER );
    add_option( NORBY_OPTION_INFO_PAGE, NORBY_DEFAULT_INFO_PAGE );
    add_option( NORBY_OPTION_WIDGET_POSITION, NORBY_DEFAULT_WIDGET_POSITION );
    add_option( NORBY_OPTION_DESKTOP_SIDE_MARGIN, NORBY_DEFAULT_DESKTOP_SIDE_MARGIN );
    add_option( NORBY_OPTION_DESKTOP_BOTTOM_MARGIN, NORBY_DEFAULT_DESKTOP_BOTTOM_MARGIN );
    add_option( NORBY_OPTION_MOBILE_SIDE_MARGIN, NORBY_DEFAULT_MOBILE_SIDE_MARGIN );
    add_option( NORBY_OPTION_MOBILE_BOTTOM_MARGIN, NORBY_DEFAULT_MOBILE_BOTTOM_MARGIN );
}
register_activation_hook( __FILE__, 'norby_plugin_activate' );

function norby_plugin_deactivate() {
    delete_option( NORBY_OPTION_API_KEY );
    delete_option( NORBY_OPTION_LANGUAGE );
    delete_option( NORBY_OPTION_COLOR );
    delete_option( NORBY_OPTION_ICON_COLOR );
    delete_option( NORBY_OPTION_MULTI_CHAT );
    delete_option( NORBY_OPTION_BOT_NAME );
    delete_option( NORBY_OPTION_IMAGE_TRANSFER );
    delete_option( NORBY_OPTION_INFO_PAGE );
    delete_option( NORBY_OPTION_WIDGET_POSITION );
    delete_option( NORBY_OPTION_DESKTOP_SIDE_MARGIN );
    delete_option( NORBY_OPTION_DESKTOP_BOTTOM_MARGIN );
    delete_option( NORBY_OPTION_MOBILE_SIDE_MARGIN );
    delete_option( NORBY_OPTION_MOBILE_BOTTOM_MARGIN );
}
register_deactivation_hook( __FILE__, 'norby_plugin_deactivate' );

function norby_plugin_enqueue_assets()
{
    wp_enqueue_style( 'norby_styles', NORBY_STYLE_URL );

    wp_register_script( 'norby-scripts', NORBY_SCRIPT_URL, [], false, true );
    wp_enqueue_script( 'norby-scripts' );
    wp_localize_script( 'norby-scripts', 'ajax_object', ['ajaxurl' => admin_url('admin-ajax.php')] );
}
add_action( 'admin_enqueue_scripts', 'norby_plugin_enqueue_assets' );

function norby_plugin_show_widget () {
    require_once NORBY_WIDGET_PATH;
}
add_action( 'wp_footer', 'norby_plugin_show_widget' );

require_once NORBY_SAVE_SETTINGS_PATH;
